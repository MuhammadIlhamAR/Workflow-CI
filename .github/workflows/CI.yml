name: CI MLflow Project (Advanced)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  train_and_deploy:
    runs-on: ubuntu-latest

    # ðŸ”‘ WAJIB: tracking URI ABSOLUTE (lebih aman di CI)
    env:
      MLFLOW_TRACKING_URI: "file:${{ github.workspace }}/mlruns"
      MLFLOW_LOG_LEVEL: "WARNING"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Check environment
        run: |
          python --version
          pip --version
          echo "Workspace:"
          pwd
          ls -la
          echo "MLProject folder:"
          ls -la "MLProject-Folder"

      - name: Install base dependencies
        run: |
          python -m pip install --upgrade pip
          # install kebutuhan project (requirements ada di folder MLProject)
          pip install -r "MLProject-Folder/requirements.txt"
          # pastikan mlflow ada
          python -c "import mlflow; print('mlflow', mlflow.__version__)"

      # âœ… SESUAI REVISI (WAJIB mlflow run)
      # âœ… Anti log panjang: env-manager local (tanpa conda)
      - name: Run MLflow Project
        run: |
          set -e
          python -m mlflow run "MLProject-Folder" --env-manager=local \
            -P input_file="PRSA_Data_Aotizhongxin_preprocessing.csv" \
            -P n_estimators=100 \
            -P max_depth=20

      # (OPSIONAL) ambil run_id terakhir (buat bukti / lanjut step lain)
      - name: Get latest MLflow run_id
        id: get_run
        run: |
          python - <<'PY'
          import os
          import mlflow
          from mlflow.tracking import MlflowClient

          client = MlflowClient()

          # experiment: pakai yang ada; kalau kamu set experiment name khusus, ganti di sini
          exp = client.get_experiment_by_name("Membangun_Model")
          if exp is None:
            exp = client.get_experiment_by_name("Default")
          exp_id = exp.experiment_id if exp else "0"

          runs = client.search_runs(
              [exp_id],
              order_by=["attributes.start_time DESC"],
              max_results=1
          )

          if not runs:
              raise SystemExit("No MLflow runs found")

          run_id = runs[0].info.run_id
          print("LATEST_RUN_ID=", run_id)

          # GitHub output
          out = os.environ.get("GITHUB_OUTPUT")
          if out:
              with open(out, "a", encoding="utf-8") as f:
                  f.write(f"run_id={run_id}\n")
          PY

      - name: Upload Training Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: training-artifacts
          path: |
            mlruns
            artifacts
          if-no-files-found: warn

      - name: CI finished
        run: echo "CI MLflow Project finished successfully âœ…"

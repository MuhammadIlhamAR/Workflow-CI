name: Build & Push Docker (Auto Detect Model)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  docker_only:
    runs-on: ubuntu-latest

    env:
      MLFLOW_TRACKING_URI: "file:${{ github.workspace }}/mlruns"
      MLFLOW_LOG_LEVEL: "WARNING"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install minimal deps
        run: |
          python -m pip install --upgrade pip
          pip install mlflow

      # Ambil RUN_ID terbaru dari mlruns lokal di repo (hasil training CI)
      - name: Get latest MLflow run_id
        id: get_run
        run: |
          python - <<'PY'
          import os
          from mlflow.tracking import MlflowClient

          c = MlflowClient()
          exp = c.get_experiment_by_name("Default")
          exp_id = exp.experiment_id if exp else "0"

          runs = c.search_runs([exp_id], order_by=["attributes.start_time DESC"], max_results=1)
          if not runs:
              raise SystemExit("No MLflow runs found in repo mlruns. Pastikan mlruns ada/terupdate.")

          run_id = runs[0].info.run_id
          print("RUN_ID:", run_id)

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
              f.write(f"run_id={run_id}\n")
          PY

      # Download semua artifacts dari run, lalu cari folder yang punya file MLmodel
      - name: Export model (auto detect MLmodel)
        env:
          RUN_ID: ${{ steps.get_run.outputs.run_id }}
        run: |
          set -e
          rm -rf run_artifacts model
          mkdir -p run_artifacts

          python - <<'PY'
          import os, shutil
          import mlflow

          run_id = os.environ["RUN_ID"]

          dst = os.path.abspath("run_artifacts")
          mlflow.artifacts.download_artifacts(run_id=run_id, artifact_path="", dst_path=dst)

          model_dir = None
          for root, _, files in os.walk(dst):
              if "MLmodel" in files:
                  model_dir = root
                  break

          if model_dir is None:
              raise SystemExit(
                  "Tidak menemukan file MLmodel pada artifacts run ini. "
                  "Artinya run tersebut tidak menyimpan MLflow Model artifact."
              )

          out = os.path.abspath("model")
          if os.path.exists(out):
              shutil.rmtree(out)
          shutil.copytree(model_dir, out)

          print("Detected model dir:", model_dir)
          print("Exported to:", out)
          print("Model files:", os.listdir(out))
          PY

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: model_docker/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/weather-mlflow-model:latest
